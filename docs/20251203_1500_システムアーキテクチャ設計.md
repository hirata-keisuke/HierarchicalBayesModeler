# システムアーキテクチャ設計書

作成日: 2025-12-03 15:00

## 1. 概要

階層ベイズモデルGUIアプリケーションの全体アーキテクチャ、API設計、データフロー、セッション管理を定義する。

---

## 2. システム全体構成

### 2.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                         クライアント                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         React + TypeScript (フロントエンド)            │   │
│  │  - ReactFlow (グラフ描画)                              │   │
│  │  - Zustand (状態管理)                                  │   │
│  │  - Material-UI (UIコンポーネント)                      │   │
│  │  - Plotly.js (可視化)                                  │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/WebSocket
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                       Nginx (リバースプロキシ)               │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        ▼                               ▼
┌──────────────────┐           ┌──────────────────┐
│   FastAPI        │           │   静的ファイル    │
│   (APIサーバー)   │◄──────────│   配信            │
└────────┬─────────┘           └──────────────────┘
         │
         │ タスク投入
         ▼
┌──────────────────┐
│   Redis          │
│ (メッセージ      │
│  ブローカー)     │
└────────┬─────────┘
         │
         │ タスク取得
         ▼
┌──────────────────┐
│   Celery Worker  │
│  - PyMC推論      │
│  - Arviz可視化   │
└────────┬─────────┘
         │
         │ 結果保存
         ▼
┌──────────────────┐
│  ファイルストレージ│
│  (結果保存)      │
└──────────────────┘
```

### 2.2 コンポーネント構成

| コンポーネント | 技術スタック | 役割 |
|--------------|------------|------|
| **フロントエンド** | React + TypeScript | グラフィカルモデル構築UI、結果表示 |
| **APIサーバー** | FastAPI | REST API提供、リクエスト処理 |
| **タスクキュー** | Celery + Redis | 非同期タスク管理 |
| **ワーカー** | Celery Worker | PyMCモデル構築、サンプリング、推論 |
| **キャッシュ/セッション** | Redis | セッション管理、タスク結果キャッシュ |
| **ストレージ** | ファイルシステム | CSV、PNG、Graphviz、推論結果保存 |
| **Webサーバー** | Nginx | 静的ファイル配信、リバースプロキシ |

---

## 3. API設計

### 3.1 エンドポイント一覧

#### 3.1.1 モデル構築関連

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | `/api/models` | モデルを新規作成 |
| GET | `/api/models/{model_id}` | モデル情報を取得 |
| PUT | `/api/models/{model_id}` | モデルを更新 |
| DELETE | `/api/models/{model_id}` | モデルを削除 |
| POST | `/api/models/{model_id}/validate` | モデルの整合性チェック |
| POST | `/api/models/{model_id}/build` | PyMCコード生成とモデル構築 |
| GET | `/api/models/{model_id}/export` | モデルをPNG/Graphviz形式でエクスポート |

#### 3.1.2 ノード・エッジ管理

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | `/api/models/{model_id}/nodes` | ノードを追加 |
| PUT | `/api/models/{model_id}/nodes/{node_id}` | ノードを更新 |
| DELETE | `/api/models/{model_id}/nodes/{node_id}` | ノードを削除 |
| POST | `/api/models/{model_id}/edges` | エッジを追加 |
| DELETE | `/api/models/{model_id}/edges/{edge_id}` | エッジを削除 |

#### 3.1.3 データ管理

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | `/api/data/upload` | CSVデータをアップロード |
| GET | `/api/data/{data_id}` | データの情報を取得 |
| GET | `/api/data/{data_id}/preview` | データのプレビュー（先頭行） |
| POST | `/api/models/{model_id}/data/mapping` | データとモデルの対応付けを設定 |

#### 3.1.4 推論実行

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | `/api/models/{model_id}/prior-predictive` | 事前分布の予測を実行 |
| POST | `/api/models/{model_id}/sample` | サンプリング実行（NUTS/VI） |
| POST | `/api/models/{model_id}/posterior-predictive` | 事後予測を実行 |
| GET | `/api/tasks/{task_id}` | タスクの状態を取得 |
| GET | `/api/tasks/{task_id}/result` | タスクの結果を取得 |

#### 3.1.5 結果取得

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| GET | `/api/results/{result_id}/summary` | パラメータ推定結果のサマリー |
| GET | `/api/results/{result_id}/trace` | トレースプロット画像 |
| GET | `/api/results/{result_id}/forest` | フォレストプロット画像 |
| GET | `/api/results/{result_id}/posterior` | 事後予測結果 |

#### 3.1.6 分布・演算管理

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| GET | `/api/distributions` | 利用可能な分布一覧を取得 |
| POST | `/api/distributions` | 新しい分布を追加 |
| GET | `/api/operations` | 利用可能な演算一覧を取得 |
| POST | `/api/operations` | 新しい演算を追加 |

### 3.2 API仕様例

#### 3.2.1 POST `/api/models`
モデルを新規作成

**リクエスト**
```json
{
  "name": "ベイズ線形回帰モデル",
  "description": "説明変数3つの線形回帰"
}
```

**レスポンス**
```json
{
  "model_id": "mdl_abc123",
  "name": "ベイズ線形回帰モデル",
  "created_at": "2025-12-03T15:00:00Z",
  "session_id": "sess_xyz789"
}
```

#### 3.2.2 POST `/api/models/{model_id}/nodes`
ノードを追加

**リクエスト**
```json
{
  "type": "latent",
  "gui_name": "回帰係数",
  "code_name": "beta",
  "shape": "(3,)",
  "distribution": "Normal",
  "parameters": {
    "mu": 0,
    "sigma": 10
  }
}
```

**レスポンス**
```json
{
  "node_id": "node_001",
  "type": "latent",
  "gui_name": "回帰係数",
  "code_name": "beta",
  "shape": "(3,)",
  "distribution": "Normal",
  "parameters": {
    "mu": 0,
    "sigma": 10
  }
}
```

#### 3.2.3 POST `/api/models/{model_id}/sample`
サンプリング実行

**リクエスト**
```json
{
  "sampler": "NUTS",
  "draws": 2000,
  "tune": 1000,
  "chains": 4,
  "target_accept": 0.95
}
```

**レスポンス**
```json
{
  "task_id": "task_abc456",
  "status": "pending",
  "message": "サンプリングタスクを開始しました"
}
```

#### 3.2.4 GET `/api/tasks/{task_id}`
タスクの状態を取得

**レスポンス**
```json
{
  "task_id": "task_abc456",
  "status": "running",
  "progress": 45,
  "message": "サンプリング中... (45%)",
  "started_at": "2025-12-03T15:05:00Z"
}
```

ステータス: `pending`, `running`, `completed`, `failed`

#### 3.2.5 GET `/api/results/{result_id}/summary`
パラメータ推定結果のサマリー

**レスポンス**
```json
{
  "result_id": "res_def789",
  "model_id": "mdl_abc123",
  "parameters": [
    {
      "name": "beta[0]",
      "mean": 2.34,
      "sd": 0.12,
      "hdi_3%": 2.10,
      "hdi_97%": 2.58,
      "r_hat": 1.01,
      "ess_bulk": 3200,
      "ess_tail": 3100
    },
    {
      "name": "beta[1]",
      "mean": -1.05,
      "sd": 0.15,
      "hdi_3%": -1.35,
      "hdi_97%": -0.75,
      "r_hat": 1.00,
      "ess_bulk": 3150,
      "ess_tail": 3050
    }
  ]
}
```

---

## 4. データフロー

### 4.1 モデル構築フロー

```
1. ユーザーがノードを追加
   ↓
2. フロントエンド: POST /api/models/{model_id}/nodes
   ↓
3. バックエンド: ノード情報をRedisに保存
   ↓
4. レスポンス返却（node_id含む）
   ↓
5. フロントエンド: ノードをキャンバスに表示
```

### 4.2 サンプリング実行フロー

```
1. ユーザーが「サンプル実行」ボタンをクリック
   ↓
2. フロントエンド: POST /api/models/{model_id}/sample
   ↓
3. FastAPI: Celeryタスクを投入
   ↓
4. レスポンス返却（task_id）
   ↓
5. フロントエンド: ポーリング開始（GET /api/tasks/{task_id}）
   ↓
6. Celery Worker: PyMCでサンプリング実行
   ↓
7. Worker: 結果をファイルシステムに保存
   ↓
8. Worker: タスク状態を "completed" に更新
   ↓
9. フロントエンド: status == "completed" を検知
   ↓
10. フロントエンド: 結果表示ページへの遷移ボタンをアクティブ化
```

### 4.3 結果表示フロー

```
1. ユーザーが結果表示ページに遷移
   ↓
2. フロントエンド: GET /api/results/{result_id}/summary
   ↓
3. バックエンド: ファイルから結果を読み込み
   ↓
4. レスポンス返却（JSON形式のサマリー）
   ↓
5. フロントエンド: サマリーテーブルを表示
   ↓
6. フロントエンド: GET /api/results/{result_id}/trace
   ↓
7. バックエンド: トレースプロット画像を返却
   ↓
8. フロントエンド: 画像を表示
```

---

## 5. セッション管理

### 5.1 セッションID
- アプリケーション起動時にUUID v4を生成
- フロントエンドがlocalStorageに保存
- すべてのAPIリクエストに `X-Session-Id` ヘッダーで送信

### 5.2 データ保存構造（Redis）

```
sessions:{session_id}
  ├─ models:{model_id}
  │   ├─ meta (JSON)
  │   ├─ nodes (Hash: node_id → node_data)
  │   ├─ edges (Hash: edge_id → edge_data)
  │   └─ data_mapping (JSON)
  └─ tasks:{task_id}
      ├─ status
      ├─ progress
      └─ result_id
```

### 5.3 ファイルストレージ構造

```
/storage
  /{session_id}
    /data
      /{data_id}.csv
    /models
      /{model_id}.png
      /{model_id}.gv
    /results
      /{result_id}
        /trace.json          # InferenceDataのJSON形式
        /summary.json        # arviz.summary()の結果
        /trace_plot.png      # トレースプロット画像
        /forest_plot.png     # フォレストプロット画像
        /posterior_pred.json # 事後予測結果
```

### 5.4 セッションのタイムアウト
- セッションは**24時間**無操作で自動削除
- 削除前に警告（Redisの`EXPIRE`コマンド）
- ファイルも自動削除

---

## 6. Celeryタスク設計

### 6.1 タスク一覧

| タスク名 | 説明 | 入力 | 出力 |
|---------|------|------|------|
| `build_model_task` | PyMCモデルを構築 | model_id, session_id | モデルオブジェクト |
| `prior_predictive_task` | 事前分布予測を実行 | model_id, session_id | 予測結果 |
| `sample_task` | サンプリングを実行 | model_id, session_id, sampler_config | InferenceData |
| `posterior_predictive_task` | 事後予測を実行 | model_id, result_id, session_id | 予測結果 |
| `generate_plots_task` | 可視化画像を生成 | result_id, plot_types | 画像ファイルパス |

### 6.2 タスクの状態管理

```python
# Celeryタスクの状態
PENDING    # タスクが投入された
STARTED    # タスクが開始された
PROGRESS   # 進行中（カスタム状態）
SUCCESS    # タスクが成功
FAILURE    # タスクが失敗
RETRY      # リトライ中
```

### 6.3 進捗レポート

サンプリングタスクは進捗を定期的に報告：
```python
@celery_app.task(bind=True)
def sample_task(self, model_id, session_id, config):
    # サンプリングのコールバックで進捗を更新
    def progress_callback(iteration, total):
        progress = int((iteration / total) * 100)
        self.update_state(
            state='PROGRESS',
            meta={'progress': progress, 'message': f'サンプリング中... ({progress}%)'}
        )

    # PyMCサンプリング実行
    with pm.Model() as model:
        # ... モデル構築 ...
        trace = pm.sample(
            draws=config['draws'],
            tune=config['tune'],
            callback=progress_callback
        )

    # 結果を保存
    result_id = save_result(trace, session_id)
    return {'result_id': result_id, 'status': 'completed'}
```

---

## 7. エラーハンドリング

### 7.1 エラーレスポンス形式

```json
{
  "error": {
    "code": "MODEL_VALIDATION_ERROR",
    "message": "モデルの整合性チェックに失敗しました",
    "details": [
      "ノード 'beta' の形状 (3,) とデータの列数 (2) が一致しません",
      "エッジ 'edge_001' の接続先ノードが見つかりません"
    ]
  }
}
```

### 7.2 エラーコード一覧

| エラーコード | 説明 |
|------------|------|
| `MODEL_VALIDATION_ERROR` | モデル整合性チェックエラー |
| `DATA_UPLOAD_ERROR` | データアップロードエラー |
| `SAMPLING_ERROR` | サンプリング実行エラー |
| `TASK_NOT_FOUND` | タスクが見つからない |
| `SESSION_EXPIRED` | セッションが期限切れ |
| `INVALID_DISTRIBUTION` | 無効な分布定義 |
| `INVALID_OPERATION` | 無効な演算定義 |

### 7.3 フロントエンドでのエラー表示

```typescript
// エラーハンドリング例
try {
  const response = await api.post(`/api/models/${modelId}/sample`, config);
} catch (error) {
  if (error.response?.data?.error) {
    const { code, message, details } = error.response.data.error;

    // エラーモーダルを表示
    showErrorModal({
      title: message,
      details: details,
      code: code
    });
  }
}
```

---

## 8. セキュリティ

### 8.1 入力バリデーション
- すべてのAPIリクエストでPydanticモデルによるバリデーション
- CSVファイルのサイズ制限（最大100MB）
- ファイル形式の検証（MIMEタイプチェック）

### 8.2 セッション分離
- セッションIDに基づくデータの完全分離
- 他のセッションのデータへのアクセスを禁止

### 8.3 コードインジェクション対策
- ユーザー入力をそのまま `eval()` しない
- PyMC関数・クラスの存在を事前にチェック
- ホワイトリスト方式で許可された関数のみ実行

### 8.4 CORS設定
```python
# FastAPIのCORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # 開発環境
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## 9. スケーラビリティ

### 9.1 水平スケーリング
- FastAPIサーバーは複数インスタンス起動可能（ステートレス）
- Celery Workerも複数起動可能
- Redisは単一インスタンス（または Redis Cluster）

### 9.2 パフォーマンス最適化
- 静的ファイルはNginxから直接配信
- APIレスポンスのgzip圧縮
- 結果のキャッシング（Redis）

### 9.3 負荷分散
```
          ┌──> FastAPI Instance 1
Nginx ────┼──> FastAPI Instance 2
          └──> FastAPI Instance 3
                      ↓
                   Redis
                      ↓
          ┌──> Celery Worker 1
          ├──> Celery Worker 2
          └──> Celery Worker 3
```

---

## 10. デプロイメント

### 10.1 Docker Compose構成

```yaml
version: '3.8'
services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/build:/usr/share/nginx/html
    depends_on:
      - api

  api:
    build: ./backend
    environment:
      - REDIS_URL=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - redis
    volumes:
      - ./storage:/app/storage

  worker:
    build: ./backend
    command: celery -A app.celery worker --loglevel=info
    environment:
      - REDIS_URL=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - redis
    volumes:
      - ./storage:/app/storage

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  redis_data:
```

### 10.2 環境変数

| 変数名 | 説明 | デフォルト値 |
|-------|------|------------|
| `REDIS_URL` | RedisのURL | `redis://localhost:6379` |
| `CELERY_BROKER_URL` | Celeryブローカー | `redis://localhost:6379/0` |
| `SESSION_TIMEOUT` | セッションタイムアウト（秒） | `86400` (24時間) |
| `MAX_FILE_SIZE` | アップロードファイルサイズ上限 | `104857600` (100MB) |
| `STORAGE_PATH` | ファイル保存先 | `/app/storage` |

---

## 11. 監視とログ

### 11.1 ログ出力
- FastAPI: 構造化ログ（JSON形式）
- Celery: タスク実行ログ
- Nginx: アクセスログ、エラーログ

### 11.2 メトリクス
- APIレスポンスタイム
- タスクの実行時間
- エラー発生率
- セッション数

### 11.3 アラート
- Celery Workerのダウン検知
- Redis接続エラー
- ディスク容量逼迫

---

## 12. 次のステップ

1. **プロトタイプ開発（Phase 1 MVP）**
   - フロントエンドの基本UI実装
   - バックエンドのAPI実装
   - Docker環境構築

2. **テスト実装**
   - ユニットテスト
   - 統合テスト
   - E2Eテスト

3. **ドキュメント整備**
   - API仕様書（OpenAPI/Swagger）
   - デプロイ手順書
   - ユーザーマニュアル
