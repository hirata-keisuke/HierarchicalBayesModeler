# ノードタイプとエッジの再設計

作成日: 2025-12-03 08:26

## 1. 現状の問題点

### 1.1 ノードタイプの不足と曖昧さ
- **データノード（説明変数）が存在しない**
  - ベイズ線形回帰で `y ~ Normal(X @ beta, sigma)` を表現する際、特徴量 `X` を表すノードがない
  - 観測変数は結果変数（目的変数）のみを表現する前提だったが、不明確

- **ハイパーパラメータと潜在変数の区別が不明確**
  - 両方とも「分布を持つ」が、階層構造における役割が異なる
  - ハイパーパラメータは潜在変数の事前分布のパラメータであるべき

### 1.2 パラメータ設定機能の欠如
- 分布のパラメータを定数で指定できない
  - 例: `Normal(mu=0, sigma=1)` のような固定値指定
- パラメータに他のノードを接続する機能が未実装
  - 例: `Normal(mu=mu_prior, sigma=sigma_prior)`

### 1.3 エッジの方向性がない
- 現在のエッジは無向グラフとして実装されている
- ベイズネットワークは**有向非巡回グラフ（DAG）**であるべき
- 親→子の依存関係が視覚的に不明確

### 1.4 演算ノードのオペランド順序が指定できない
- `A - B` と `B - A` の区別ができない
- `A @ B`（行列積）では順序が重要だが制御不可能

---

## 2. 改訂後のノードタイプ定義

### 2.1 ノードタイプ一覧

| ノード種類 | PyMC対応 | 説明 | 設定項目 | 例 |
|-----------|---------|------|---------|-----|
| **データ（説明変数）** | `pm.Data()` | 入力データ（CSVから読み込み、分布なし） | 変数名、形状、CSVマッピング | 特徴量 `X` |
| **観測変数** | `pm.Normal(..., observed=y_data)` | 目的変数（CSVから読み込み、分布あり） | 変数名、形状、分布、CSVマッピング | 結果変数 `y` |
| **潜在変数** | `pm.Normal(...)` | 推定対象のパラメータ（分布あり） | 変数名、形状、分布、パラメータ接続 | 回帰係数 `beta` |
| **ハイパーパラメータ** | `pm.HalfNormal(...)` | 階層的事前分布のパラメータ（分布あり） | 変数名、形状、分布、パラメータ接続 | `sigma`, `tau` |
| **演算ノード** | `pm.Deterministic()` | 他のノードの演算結果（分布なし） | 変数名、形状、演算タイプ、入力接続 | `mu = X @ beta` |
| **定数** | Python定数 | 固定値（分布パラメータとして使用） | 変数名、値（スカラーまたは配列） | `0`, `1.0`, `[0, 0]` |

### 2.2 ノードタイプの詳細仕様

#### 2.2.1 データノード（説明変数）
- **目的**: 観測データのうち、モデルの入力となる説明変数を表現
- **PyMC対応**: `pm.Data("X", value=X_data)`
- **設定項目**:
  - GUI変数名（日本語可）
  - コード変数名（英数字・アンダースコア）
  - 形状（例: `(n_observations, 5)` ）
  - CSVマッピング（列選択）
- **出力ハンドル**: 1つ（他のノードへデータを提供）
- **入力ハンドル**: なし

#### 2.2.2 観測変数ノード
- **目的**: 観測データのうち、モデルの出力（目的変数）を表現
- **PyMC対応**: `pm.Normal("y", mu=mu, sigma=sigma, observed=y_data)`
- **設定項目**:
  - GUI変数名、コード変数名
  - 形状（例: `(n_observations,)` ）
  - 従う分布（Normal, Poisson等）
  - 各分布パラメータ（定数 or ノード接続）
  - CSVマッピング（列選択）
- **入力ハンドル**: 分布パラメータごとに1つ（例: Normal なら `mu`, `sigma`）
- **出力ハンドル**: なし（観測データなので他のノードの親にならない）

#### 2.2.3 潜在変数ノード
- **目的**: モデルの推定対象となる隠れたパラメータ
- **PyMC対応**: `pm.Normal("beta", mu=0, sigma=1)`
- **設定項目**:
  - GUI変数名、コード変数名
  - 形状（例: `(5,)` ）
  - 従う分布
  - 各分布パラメータ（定数 or ノード接続）
- **入力ハンドル**: 分布パラメータごとに1つ
- **出力ハンドル**: 1つ（他のノードの親になる）

#### 2.2.4 ハイパーパラメータノード
- **目的**: 潜在変数の事前分布を制御するパラメータ（階層ベイズの階層部分）
- **PyMC対応**: `pm.HalfNormal("sigma", sigma=1)`
- **設定項目**:
  - GUI変数名、コード変数名
  - 形状（通常はスカラー）
  - 従う分布（通常は無情報事前分布）
  - 各分布パラメータ（定数 or ノード接続）
- **入力ハンドル**: 分布パラメータごとに1つ
- **出力ハンドル**: 1つ（潜在変数のパラメータとして接続される）

#### 2.2.5 演算ノード
- **目的**: パラメータやデータの演算結果を表現
- **PyMC対応**: `pm.Deterministic("mu", X @ beta)`
- **設定項目**:
  - GUI変数名、コード変数名
  - 形状（演算結果の形状）
  - 演算タイプ（add, subtract, multiply, matmul, exp, log, sqrt, abs, sigmoid, softmax）
  - 入力接続（演算タイプに応じた数とラベル）
- **入力ハンドル**: 演算タイプに応じて複数
  - 例: `add` なら `operand_1`, `operand_2`
  - 例: `matmul` なら `left`, `right`
  - 例: `exp` なら `input`
- **出力ハンドル**: 1つ

#### 2.2.6 定数ノード
- **目的**: 固定値を提供（分布パラメータや演算の入力として使用）
- **PyMC対応**: Pythonの定数として直接埋め込み
- **設定項目**:
  - GUI変数名、コード変数名
  - 値（スカラー: `0`, `1.0` またはベクトル: `[0, 0]`）
- **入力ハンドル**: なし
- **出力ハンドル**: 1つ

---

## 3. エッジの有向化仕様

### 3.1 エッジの方向
- **全てのエッジは有向**とする
- **親ノード（source）** → **子ノード（target）** の依存関係を表現
- ReactFlowの`Edge`型を使用し、`markerEnd`で矢印を表示

### 3.2 ハンドル（接続ポイント）の設計

#### 3.2.1 ハンドルの種類
- **出力ハンドル（source handle）**: 親ノード側、他のノードに値を提供
- **入力ハンドル（target handle）**: 子ノード側、他のノードから値を受け取る

#### 3.2.2 ハンドルの配置
- 出力ハンドル: ノードの右側
- 入力ハンドル: ノードの左側（パラメータ名ごとに複数配置）

#### 3.2.3 接続ルール
- **データノード** → 演算ノードまたは観測変数ノード
- **潜在変数/ハイパーパラメータ** → 他の潜在変数/ハイパーパラメータ/観測変数のパラメータ
- **演算ノード** → 潜在変数/観測変数のパラメータ
- **定数ノード** → 任意のノードのパラメータ

#### 3.2.4 循環検出
- DAGであることを保証するため、エッジ追加時に循環参照を検出
- 循環が発生する接続はエラーとして拒否

---

## 4. パラメータ接続の仕様

### 4.1 パラメータ設定の2つの方法
1. **定数値を直接入力**
   - UI上でテキストフィールドに値を入力（例: `0`, `1.0`, `[0, 1]`）
   - 内部的には定数ノードとして扱う（非表示）
   
2. **他のノードを接続**
   - 分布パラメータの入力ハンドルに親ノードを接続
   - 例: `Normal`の`mu`ハンドルに演算ノード`X @ beta`を接続

### 4.2 パラメータハンドルのUI表現
- 各分布パラメータに名前付きハンドルを表示
  - 例: Normal分布のノードには `mu` と `sigma` の2つのハンドルを左��に配置
- パラメータに値が設定されていない場合は警告表示
- パラメータに接続がある場合はエッジで表示、ない場合は定数値を表示

---

## 5. 具体例: ベイズ線形回帰

### 5.1 モデル定義
```
y ~ Normal(mu, sigma)
mu = X @ beta
beta ~ Normal(0, tau)
sigma ~ HalfNormal(1)
tau ~ HalfNormal(1)
```

### 5.2 ノード構成

| ノード名 | タイプ | 設定 |
|---------|-------|------|
| `X` | データ | 形状: `(n_observations, k_features)`, CSV列選択 |
| `y` | 観測変数 | 分布: Normal, 形状: `(n_observations,)`, CSV列選択 |
| `beta` | 潜在変数 | 分布: Normal, 形状: `(k_features,)` |
| `sigma` | ハイパーパラメータ | 分布: HalfNormal, 形状: `()` |
| `tau` | ハイパーパラメータ | 分布: HalfNormal, 形状: `()` |
| `mu` | 演算ノード | 演算: matmul, 形状: `(n_observations,)` |
| `0` | 定数 | 値: 0 |
| `1` | 定数 | 値: 1 |

### 5.3 エッジ構成

| 親ノード | 親ハンドル | 子ノード | 子ハンドル |
|---------|----------|---------|----------|
| `X` | `output` | `mu` | `left` |
| `beta` | `output` | `mu` | `right` |
| `mu` | `output` | `y` | `mu` |
| `sigma` | `output` | `y` | `sigma` |
| `0` | `output` | `beta` | `mu` |
| `tau` | `output` | `beta` | `sigma` |
| `1` | `output` | `sigma` | `sigma` |
| `1` | `output` | `tau` | `sigma` |

### 5.4 グラフ構造（ASCII図）
```
    [1] ───→ [tau] ───→ [beta] ───┐
                ↓                  │
    [0] ───────┘                   │
                                   ↓
    [X] ───┐                      [mu] ───┐
           └──→ [mu (演算)] ───────┘      │
                                          ↓
    [1] ───→ [sigma] ──────────→ [y (観測)] ←── [y_data (CSV)]
```

---

## 6. 実装への影響

### 6.1 スキーマ変更（backend）
- `NodeCreate`, `NodeUpdate`, `NodeResponse` に以下を追加:
  - `constant_value`: Optional[Union[float, List[float]]]
  - `csv_mapping`: Optional[Dict[str, str]]

- `EdgeCreate`, `EdgeResponse` に以下を追加:
  - `source_handle`: str（出力ハンドルID）
  - `target_handle`: str（入力ハンドルID）

### 6.2 分布定義JSON拡張
- 各分布のパラメータ定義に `handle_id` を追加
```json
{
  "name": "normal",
  "parameters": [
    {
      "name": "mu",
      "handle_id": "mu",
      "type": "float",
      "required": true
    },
    {
      "name": "sigma",
      "handle_id": "sigma",
      "type": "float",
      "required": true
    }
  ]
}
```

### 6.3 演算定義JSON拡張
- 各演算のオペランドに `handle_id` を追加
```json
{
  "name": "matmul",
  "operands": 2,
  "operand_names": ["left", "right"],
  "handles": [
    {"id": "left", "label": "左行列"},
    {"id": "right", "label": "右行列"}
  ]
}
```

### 6.4 フロントエンド変更
- CustomNodeコンポーネントにハンドルを動的生成
- ノードタイプに応じて入力ハンドルを配置
- エッジに矢印マーカーを追加
- DAG検証ロジックの追加

---

## 7. 次のステップ

1. スキーマ更新（schemas.py）
2. 分布・演算JSON拡張
3. CustomNodeコンポーネントのハンドル対応
4. NodeEditorでのパラメータ設定UI実装
5. DAG検証ロジック実装
6. 既存コードのマイグレーション

---

## 8. 補足: ノードタイプ使い分けガイド

### 8.1 ハイパーパラメータ vs 潜在変数
- **潜在変数**: 推定したいメインのパラメータ（例: 回帰係数、切片）
- **ハイパーパラメータ**: 潜在変数の事前分布を制御するパラメータ（例: 分散、スケール）

### 8.2 データノード vs 観測変数ノード
- **データノード**: 説明変数（X）、モデルへの入力、分布なし
- **観測変数ノード**: 目的変数（y）、モデルの出力、分布あり、推論のターゲット

### 8.3 定数ノード vs 固定値入力
- **定数ノード**: 複数箇所で再利用する値（例: 全ての事前分布の平均を0にする）
- **固定値入力**: ノードエディタで直接入力（内部的には非表示の定数ノードとして扱う）
