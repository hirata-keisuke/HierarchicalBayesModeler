# 演算と分布の定義スキーマ設計書

作成日: 2025-12-03 14:45

## 1. 概要

階層ベイズモデルGUIアプリケーションにおいて、演算と確率分布の定義をJSON形式で外部ファイル化し、ソースコードを変更せずに拡張可能にするためのスキーマ設計。

---

## 2. 演算定義のJSONスキーマ

### 2.1 スキーマ仕様

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["name", "display_name", "notation", "pymc_function", "operands"],
  "properties": {
    "name": {
      "type": "string",
      "description": "演算の一意な識別子（英数字とアンダースコア）",
      "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
    },
    "display_name": {
      "type": "string",
      "description": "GUI上に表示される演算名（日本語可）"
    },
    "notation": {
      "type": "string",
      "description": "演算の表記法（プレースホルダー: {A}, {B}, ...）",
      "examples": ["{A} + {B}", "exp({A})", "{A} @ {B}"]
    },
    "pymc_function": {
      "type": "string",
      "description": "対応するPyMC関数名（pm.math.xxx 形式）",
      "pattern": "^pm\\.math\\.[a-zA-Z_][a-zA-Z0-9_]*$"
    },
    "operands": {
      "type": "integer",
      "minimum": 1,
      "maximum": 3,
      "description": "オペランドの数（1: 単項演算, 2: 二項演算, 3: 三項演算）"
    },
    "operand_names": {
      "type": "array",
      "items": {"type": "string"},
      "description": "各オペランドの名前（表示用）",
      "minItems": 1,
      "maxItems": 3
    },
    "broadcasting": {
      "type": "boolean",
      "default": true,
      "description": "ブロードキャスティング対応の有無"
    },
    "description": {
      "type": "string",
      "description": "演算の詳細説明"
    }
  }
}
```

### 2.2 演算定義の例

#### operations.json
```json
[
  {
    "name": "add",
    "display_name": "和",
    "notation": "{A} + {B}",
    "pymc_function": "pm.math.add",
    "operands": 2,
    "operand_names": ["A", "B"],
    "broadcasting": true,
    "description": "要素ごとの加算。異なる形状の配列にも対応（ブロードキャスト）"
  },
  {
    "name": "subtract",
    "display_name": "差",
    "notation": "{A} - {B}",
    "pymc_function": "pm.math.subtract",
    "operands": 2,
    "operand_names": ["A", "B"],
    "broadcasting": true,
    "description": "要素ごとの減算"
  },
  {
    "name": "multiply",
    "display_name": "積",
    "notation": "{A} * {B}",
    "pymc_function": "pm.math.multiply",
    "operands": 2,
    "operand_names": ["A", "B"],
    "broadcasting": true,
    "description": "要素ごとの乗算（アダマール積）"
  },
  {
    "name": "matmul",
    "display_name": "行列積",
    "notation": "{A} @ {B}",
    "pymc_function": "pm.math.dot",
    "operands": 2,
    "operand_names": ["A", "B"],
    "broadcasting": false,
    "description": "行列の内積。形状は (M, K) @ (K, N) → (M, N)"
  },
  {
    "name": "exp",
    "display_name": "指数",
    "notation": "exp({A})",
    "pymc_function": "pm.math.exp",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "自然指数関数 e^x"
  },
  {
    "name": "log",
    "display_name": "対数",
    "notation": "log({A})",
    "pymc_function": "pm.math.log",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "自然対数 ln(x)"
  },
  {
    "name": "sqrt",
    "display_name": "平方根",
    "notation": "sqrt({A})",
    "pymc_function": "pm.math.sqrt",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "平方根 √x"
  },
  {
    "name": "abs",
    "display_name": "絶対値",
    "notation": "abs({A})",
    "pymc_function": "pm.math.abs_",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "絶対値 |x|"
  },
  {
    "name": "sigmoid",
    "display_name": "シグモイド",
    "notation": "sigmoid({A})",
    "pymc_function": "pm.math.sigmoid",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "シグモイド関数 1 / (1 + e^(-x))"
  },
  {
    "name": "softmax",
    "display_name": "ソフトマックス",
    "notation": "softmax({A})",
    "pymc_function": "pm.math.softmax",
    "operands": 1,
    "operand_names": ["A"],
    "broadcasting": true,
    "description": "ソフトマックス関数（確率分布への変換）"
  }
]
```

---

## 3. 確率分布定義のJSONスキーマ

### 3.1 スキーマ仕様

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["name", "display_name", "parameters", "pymc_class", "support"],
  "properties": {
    "name": {
      "type": "string",
      "description": "分布の一意な識別子（英数字とアンダースコア）",
      "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
    },
    "display_name": {
      "type": "string",
      "description": "GUI上に表示される分布名（日本語可）"
    },
    "parameters": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "display_name", "type"],
        "properties": {
          "name": {
            "type": "string",
            "description": "パラメータ名（PyMCのパラメータ名と一致）"
          },
          "display_name": {
            "type": "string",
            "description": "GUI上に表示されるパラメータ名"
          },
          "type": {
            "type": "string",
            "enum": ["real", "positive_real", "integer", "positive_integer", "probability", "vector", "matrix"],
            "description": "パラメータの型制約"
          },
          "default": {
            "description": "デフォルト値（型に応じて数値、配列など）"
          },
          "description": {
            "type": "string",
            "description": "パラメータの説明"
          },
          "required": {
            "type": "boolean",
            "default": true,
            "description": "必須パラメータかどうか"
          }
        }
      },
      "description": "分布のパラメータリスト"
    },
    "pymc_class": {
      "type": "string",
      "description": "対応するPyMCクラス名（pm.Xxx 形式）",
      "pattern": "^pm\\.[A-Z][a-zA-Z0-9_]*$"
    },
    "support": {
      "type": "string",
      "enum": ["real", "positive_real", "unit_interval", "integer", "positive_integer", "simplex"],
      "description": "分布の台（サポート）"
    },
    "multivariate": {
      "type": "boolean",
      "default": false,
      "description": "多変量分布かどうか"
    },
    "description": {
      "type": "string",
      "description": "分布の詳細説明"
    }
  }
}
```

### 3.2 分布定義の例

#### distributions.json
```json
[
  {
    "name": "Normal",
    "display_name": "正規分布",
    "parameters": [
      {
        "name": "mu",
        "display_name": "平均 μ",
        "type": "real",
        "default": 0,
        "description": "分布の平均値"
      },
      {
        "name": "sigma",
        "display_name": "標準偏差 σ",
        "type": "positive_real",
        "default": 1,
        "description": "分布の標準偏差（正の値）"
      }
    ],
    "pymc_class": "pm.Normal",
    "support": "real",
    "multivariate": false,
    "description": "最も基本的な連続確率分布。多くの自然現象をモデル化できる"
  },
  {
    "name": "Gamma",
    "display_name": "ガンマ分布",
    "parameters": [
      {
        "name": "alpha",
        "display_name": "形状パラメータ α",
        "type": "positive_real",
        "default": 1,
        "description": "分布の形状を決定"
      },
      {
        "name": "beta",
        "display_name": "逆尺度パラメータ β",
        "type": "positive_real",
        "default": 1,
        "description": "尺度の逆数"
      }
    ],
    "pymc_class": "pm.Gamma",
    "support": "positive_real",
    "multivariate": false,
    "description": "正の値を取る連続確率分布。待ち時間や精度パラメータのモデル化に使用"
  },
  {
    "name": "Beta",
    "display_name": "ベータ分布",
    "parameters": [
      {
        "name": "alpha",
        "display_name": "形状パラメータ α",
        "type": "positive_real",
        "default": 1,
        "description": "成功回数に関連"
      },
      {
        "name": "beta",
        "display_name": "形状パラメータ β",
        "type": "positive_real",
        "default": 1,
        "description": "失敗回数に関連"
      }
    ],
    "pymc_class": "pm.Beta",
    "support": "unit_interval",
    "multivariate": false,
    "description": "[0, 1] の範囲の連続確率分布。確率や比率のモデル化に使用"
  },
  {
    "name": "Bernoulli",
    "display_name": "ベルヌーイ分布",
    "parameters": [
      {
        "name": "p",
        "display_name": "成功確率 p",
        "type": "probability",
        "default": 0.5,
        "description": "1が出る確率（0 ≤ p ≤ 1）"
      }
    ],
    "pymc_class": "pm.Bernoulli",
    "support": "integer",
    "multivariate": false,
    "description": "0または1の値を取る離散確率分布。二値分類やコイントスのモデル化に使用"
  },
  {
    "name": "Poisson",
    "display_name": "ポアソン分布",
    "parameters": [
      {
        "name": "mu",
        "display_name": "平均発生率 λ",
        "type": "positive_real",
        "default": 1,
        "description": "単位時間あたりの平均発生回数"
      }
    ],
    "pymc_class": "pm.Poisson",
    "support": "positive_integer",
    "multivariate": false,
    "description": "非負整数を取る離散確率分布。カウントデータのモデル化に使用"
  },
  {
    "name": "MvNormal",
    "display_name": "多変量正規分布",
    "parameters": [
      {
        "name": "mu",
        "display_name": "平均ベクトル μ",
        "type": "vector",
        "description": "各次元の平均値"
      },
      {
        "name": "cov",
        "display_name": "共分散行列 Σ",
        "type": "matrix",
        "description": "変数間の共分散を表す正定値対称行列",
        "required": false
      },
      {
        "name": "chol",
        "display_name": "コレスキー分解 L",
        "type": "matrix",
        "description": "共分散行列のコレスキー分解（下三角行列）",
        "required": false
      },
      {
        "name": "tau",
        "display_name": "精度行列 Τ",
        "type": "matrix",
        "description": "共分散行列の逆行列",
        "required": false
      }
    ],
    "pymc_class": "pm.MvNormal",
    "support": "real",
    "multivariate": true,
    "description": "多変量の正規分布。cov、chol、tauのいずれか1つを指定"
  },
  {
    "name": "LKJCholeskyCov",
    "display_name": "LKJコレスキー共分散",
    "parameters": [
      {
        "name": "n",
        "display_name": "次元数",
        "type": "positive_integer",
        "description": "相関行列の次元"
      },
      {
        "name": "eta",
        "display_name": "濃度パラメータ η",
        "type": "positive_real",
        "default": 1,
        "description": "相関の強さを制御（η=1: 一様分布、η>1: 無相関に近い）"
      },
      {
        "name": "sd_dist",
        "display_name": "標準偏差の事前分布",
        "type": "distribution",
        "description": "各次元の標準偏差の事前分布"
      }
    ],
    "pymc_class": "pm.LKJCholeskyCov",
    "support": "positive_real",
    "multivariate": true,
    "description": "相関行列のコレスキー分解と標準偏差を組み合わせた共分散行列の事前分布"
  },
  {
    "name": "Uniform",
    "display_name": "一様分布",
    "parameters": [
      {
        "name": "lower",
        "display_name": "下限",
        "type": "real",
        "default": 0,
        "description": "分布の下限値"
      },
      {
        "name": "upper",
        "display_name": "上限",
        "type": "real",
        "default": 1,
        "description": "分布の上限値"
      }
    ],
    "pymc_class": "pm.Uniform",
    "support": "real",
    "multivariate": false,
    "description": "指定された範囲内で一様な確率分布"
  },
  {
    "name": "Exponential",
    "display_name": "指数分布",
    "parameters": [
      {
        "name": "lam",
        "display_name": "率パラメータ λ",
        "type": "positive_real",
        "default": 1,
        "description": "発生率の逆数がスケール"
      }
    ],
    "pymc_class": "pm.Exponential",
    "support": "positive_real",
    "multivariate": false,
    "description": "待ち時間をモデル化する連続確率分布"
  },
  {
    "name": "HalfNormal",
    "display_name": "半正規分布",
    "parameters": [
      {
        "name": "sigma",
        "display_name": "標準偏差 σ",
        "type": "positive_real",
        "default": 1,
        "description": "分布のスケール"
      }
    ],
    "pymc_class": "pm.HalfNormal",
    "support": "positive_real",
    "multivariate": false,
    "description": "正の値のみを取る正規分布。標準偏差の事前分布によく使用"
  }
]
```

---

## 4. ファイル配置

### 4.1 ディレクトリ構造
```
/config
  /distributions
    distributions.json      # 標準分布定義
    custom_distributions.json  # ユーザー追加分布
  /operations
    operations.json         # 標準演算定義
    custom_operations.json  # ユーザー追加演算
```

### 4.2 読み込み順序
1. 標準定義ファイル（`distributions.json`, `operations.json`）を読み込み
2. カスタム定義ファイル（`custom_*.json`）があれば追加で読み込み
3. 同名の定義がある場合、カスタム定義が優先

---

## 5. バリデーション

### 5.1 演算定義のバリデーション
- [ ] `name` が一意であること
- [ ] `pymc_function` がPyMC.mathに存在すること
- [ ] `operand_names` の長さが `operands` と一致すること
- [ ] `notation` 内のプレースホルダー数が `operands` と一致すること

### 5.2 分布定義のバリデーション
- [ ] `name` が一意であること
- [ ] `pymc_class` がPyMCに存在すること
- [ ] パラメータの `type` が有効な値であること
- [ ] `default` の型が `type` と整合していること
- [ ] 多変量分布の場合、`multivariate: true` が設定されていること

### 5.3 GUI上でのバリデーション
- ユーザーが新しい演算・分布を追加する際、上記のバリデーションを実行
- エラーがあれば具体的なメッセージを表示
- 追加前にプレビュー機能を提供

---

## 6. GUI上での追加機能

### 6.1 演算の追加UI
```
[演算を追加]ボタン → モーダルウィンドウ

フォーム:
- 演算名（英数字）: [入力欄]
- 表示名（日本語可）: [入力欄]
- 表記法: [入力欄] 例: {A} @ {B}
- PyMC関数: [入力欄] 例: pm.math.dot
- オペランド数: [1] [2] [3] （ラジオボタン）
- オペランド名: [A], [B] （オペランド数に応じて動的に表示）
- ブロードキャスト対応: [✓] （チェックボックス）
- 説明: [テキストエリア]

[プレビュー] [追加] [キャンセル]
```

### 6.2 分布の追加UI
```
[分布を追加]ボタン → モーダルウィンドウ

フォーム:
- 分布名（英数字）: [入力欄]
- 表示名（日本語可）: [入力欄]
- PyMCクラス: [入力欄] 例: pm.Normal
- サポート: [ドロップダウン] real | positive_real | unit_interval | ...
- 多変量分布: [✓] （チェックボックス）
- 説明: [テキストエリア]

パラメータ（動的に追加可能）:
  [パラメータ1]
    - パラメータ名: [入力欄]
    - 表示名: [入力欄]
    - 型: [ドロップダウン]
    - デフォルト値: [入力欄]
    - 必須: [✓]
  [+ パラメータを追加]

[プレビュー] [追加] [キャンセル]
```

---

## 7. 実装上の注意点

### 7.1 セキュリティ
- ユーザー入力をサニタイズ
- PyMC関数・クラスの存在チェック（実行前）
- JSONインジェクション対策

### 7.2 パフォーマンス
- 定義ファイルはアプリケーション起動時に一度だけ読み込み
- メモリ上にキャッシュ
- 追加時のみファイルに書き込み

### 7.3 拡張性
- 将来的にYAML形式もサポート可能にする
- バージョン管理（`"schema_version": "1.0.0"`）を含める
- 後方互換性を保つためのマイグレーション機能

---

## 8. 次のステップ

1. **JSONファイルの初期版を作成**
   - `config/distributions/distributions.json`
   - `config/operations/operations.json`

2. **バックエンドの読み込み機構を実装**
   - JSONをパースしてPythonオブジェクトに変換
   - バリデーション機能

3. **フロントエンドの表示機構を実装**
   - APIから演算・分布リストを取得
   - ドロップダウンに動的に反映

4. **追加機能のUI実装**
   - モーダルウィンドウとフォームバリデーション
