# 階層ベイズモデルGUIアプリケーション 要件定義書

作成日: 2025-12-03 14:30

## 1. プロジェクト概要

### 1.1 目的
マーケティングやデータサイエンスの分析において、階層ベイズモデルをGUIで直感的に構築し、観測データにフィッティングして推論を実行できるWebアプリケーションを開発する。説明性・解釈性・透明性を重視した分析環境を提供する。

### 1.2 主要機能
- グラフィカルモデルの視覚的構築
- PyMCベースの推論エンジン
- 観測データのフィッティングと結果の可視化
- 事前分布・事後分布の予測
- モデルのエクスポート機能

---

## 2. グラフィカルモデル構築機能

### 2.1 ノードの種類
| ノード種類 | 説明 | 設定項目 |
|-----------|------|---------|
| 観測変数 | データから観測される変数 | 変数名、形状、従う分布 |
| 潜在変数 | 推定対象の隠れた変数 | 変数名、形状、従う分布 |
| ハイパーパラメータ | 事前分布のパラメータ | 変数名、形状、従う分布 |
| 演算ノード | パラメータ同士やパラメータとデータの演算を行うノード（`pm.Deterministic()`に対応） | 変数名、形状、演算タイプ |

### 2.2 ノードの操作
- **追加**: ノード種類を選択して追加
- **設定**: 左クリックで設定画面を開く
  - 変数名（日本語可）
  - 形状（shape）
  - 従う分布の指定（確率変数の場合）
  - 分布のパラメータ（デフォルト値 or 事前分布）
- **移動**: ドラッグで位置調整
- **表示内容**: ノード上に以下を表示
  - 変数名
  - 従う分布（確率変数の場合）
  - パラメータの値または分布（確率変数の場合）
  - 演算式（演算ノードの場合、例: `X @ beta`）

### 2.3 エッジの操作
- ノードを左クリックして接続先のノードまたはパラメータを選択
- エッジは依存関係を表現

### 2.4 プレート記法
- 「プレートに追加」ボタンで複数ノードを選択
- プレート内のノードは同一の確率モデルの繰り返しを表現
- プレートにはインデックス範囲を指定

### 2.5 変数名の管理
- **GUI表示用名前**: 日本語可、説明的な名前
- **コード変数名**: 自動生成または手動設定（英数字とアンダースコア）
- GUI名 ↔ コード変数名の対応表を内部で管理

### 2.6 モデル初期化
- 「モデル初期化」ボタンでグラフをリセット

---

## 3. 演算ノードの仕様

### 3.1 演算の種類
演算ノードは `pm.Deterministic()` に対応し、他のノード（パラメータやデータ）の演算結果を表現します。

#### 対応する演算（初期実装）
| 演算タイプ | 表示記法 | PyMC.math対応 | 説明 |
|-----------|---------|--------------|------|
| 和 | `A + B` | `pm.math.add()` | 要素ごとの加算 |
| 差 | `A - B` | `pm.math.subtract()` | 要素ごとの減算 |
| 積 | `A * B` | `pm.math.multiply()` | 要素ごとの乗算（ブロードキャスト対応） |
| 行列積 | `A @ B` | `pm.math.dot()` | 行列の内積 |
| 指数 | `exp(A)` | `pm.math.exp()` | 自然指数関数 |
| 対数 | `log(A)` | `pm.math.log()` | 自然対数 |
| 平方根 | `sqrt(A)` | `pm.math.sqrt()` | 平方根 |
| 絶対値 | `abs(A)` | `pm.math.abs_()` | 絶対値 |
| シグモイド | `sigmoid(A)` | `pm.math.sigmoid()` | シグモイド関数 |
| ソフトマックス | `softmax(A)` | `pm.math.softmax()` | ソフトマックス関数 |

### 3.2 演算の指定方法
- ユーザーは演算ノード作成時に**ドロップダウンメニュー**から演算タイプを選択
- 演算に必要な入力（オペランド）をエッジで接続
- 形状の整合性は自動判定（ブロードキャスティング対応）

### 3.3 演算ノードの表示
ノード上には計算式が表示される：
- 例: `y_pred = X @ beta`
- 例: `log_likelihood = log(p)`

### 3.4 演算の拡張性
重要要件: **ソースコードを編集せずに新しい演算を追加可能**

#### 実装方針
- 演算定義をJSON形式で外部ファイル化
- 演算定義フォーマット:
  ```json
  {
    "name": "matmul",
    "display_name": "行列積",
    "notation": "{A} @ {B}",
    "pymc_function": "pm.math.dot",
    "operands": 2,
    "operand_names": ["A", "B"],
    "broadcasting": true
  }
  ```
- GUI上で「演算の追加」機能を提供

---

## 4. 確率分布の管理

### 4.1 基本分布
以下の基本的な分布を標準装備：
- **連続分布**: Normal, Gamma, Beta, Uniform, Exponential, StudentT, HalfNormal, HalfCauchy
- **離散分布**: Bernoulli, Binomial, Poisson, Categorical, Multinomial
- **多変量分布**: MvNormal, LKJCholeskyCov, Dirichlet, Wishart

### 4.2 分布の拡張性
重要要件: **ソースコードを編集せずに新しい分布を追加可能**

#### 実装方針
- 分布定義をJSON/YAML形式で外部ファイル化
- 分布定義フォーマット:
  ```json
  {
    "name": "Normal",
    "display_name": "正規分布",
    "parameters": [
      {"name": "mu", "display_name": "平均", "type": "real", "default": 0},
      {"name": "sigma", "display_name": "標準偏差", "type": "positive_real", "default": 1}
    ],
    "pymc_class": "pm.Normal",
    "support": "real"
  }
  ```
- GUI上で「分布の追加」機能を提供
  - 分布名、パラメータ、PyMCクラス名を入力
  - 入力内容を検証して分布リストに追加

---

---

## 5. データとモデルの対応付け

### 5.1 形状の指定方法
- ユーザーは形状を `(N, K)` のような記法で入力
- **予約語**: `n_observations` はデータの行数を表す
  - 例: `(n_observations, 3)` → データが100行なら `(100, 3)`
- 多次元配列も同様の記法: `(n_observations, K, D)`

### 5.2 CSVデータとの対応付け
観測変数にCSVデータを手動で対応付けます。

#### スカラー変数の場合
```
観測変数: y (形状: (n_observations,))
対応するCSV列: [y] (ドロップダウンで選択)
```

#### 多次元変数の場合
```
観測変数: X (形状: (n_observations, 3))
対応するCSV列:
  列1: [x1] (ドロップダウン)
  列2: [x2] (ドロップダウン)
  列3: [x3] (ドロップダウン)
```

または、列範囲で一括指定：
```
列範囲: [x1] から [x3] まで
```

### 5.3 データプレビュー
- CSVアップロード後、データの先頭数行を表示
- 列名と型を確認可能

---

## 6. 推論エンジン (PyMC)

### 6.1 モデル構築フロー
1. 「モデル構築」ボタンを押す
2. GUIで構築したグラフをPyMCコードに変換
3. データ形状との整合性チェック
   - 各ノードの形状がデータと一致するか
   - プレートのインデックス範囲が妥当か
   - 依存関係に循環がないか
4. 整合性確認後、モデルを内部で構築

### 6.2 モデルのエクスポート
- **形式**: PNG画像、Graphviz形式
- 「ダウンロード」ボタンでエクスポート

### 6.3 事前分布の予測
- 「事前分布の予測」ボタンで実行
- 実行中はローディングマークを表示
- 実行完了後、結果表示ページへの遷移ボタンがアクティブ化

---

## 7. データ入出力と推論実行

### 7.1 実行状態の表示
以下の処理中は**ローディングマーク**を表示：
- モデル構築中
- 事前分布予測中
- フィッティング中（サンプリング/VI）
- 事後分布予測中

### 7.2 観測データの入力
- 「事前分布の予測」ボタンで実行
- 実行完了後、結果表示ページへの遷移ボタンがアクティブ化

### 7.3 サンプリング実行
- 「サンプル実行」ボタンでフィッティング開始
- サンプラー選択（ラジオボタン）:
  - NUTS (No-U-Turn Sampler)
  - VI (Variational Inference)
- サンプリングパラメータの設定:
  - draws数
  - chains数（NUTSの場合）
  - tune数（NUTSの場合）

### 7.4 結果の可視化
フィッティング完了後、以下を表示するページへ遷移：
- **収束診断**:
  - `arviz.plot_trace()`: トレースプロットとKDEプロット
  - `arviz.plot_forest()`: フォレストプロット
- **パラメータ推定結果**:
  - 各パラメータの平均値
  - 95% HDI (Highest Density Interval)
  - R-hat値、ESS (Effective Sample Size)

### 7.5 事後予測
- 「推論実行」ボタンで事後予測を実行
- 実行完了後、事後予測表示ページへの遷移ボタンがアクティブ化
- 事後予測分布の可視化

---

---

## 8. UI/UXデザイン

### 8.1 画面構成
- **メイン画面**: グラフィカルモデル構築キャンバス
- **サイドバー**: ノード追加、設定パネル
- **ハンバーガーメニュー**: 各種遷移ボタンを格納
  - モデル構築
  - 事前分布予測
  - サンプル実行
  - 結果表示
  - 事後予測
  - モデルダウンロード

### 8.2 ナビゲーション
- ボタンは基本的に非アクティブ状態
- 前段階の処理が完了すると、次のステップのボタンがアクティブ化
- ハンバーガーメニューで画面の煩雑さを回避

---

---

## 9. 技術スタック提案

### 9.1 フロントエンド
- **フレームワーク**: React + TypeScript
- **グラフ描画**: ReactFlow (ノード・エッジの操作に優れる)
- **状態管理**: Zustand or Redux Toolkit
- **UI コンポーネント**: Material-UI or Ant Design
- **チャート**: Plotly.js (インタラクティブな可視化)

### 9.2 バックエンド
- **フレームワーク**: FastAPI (Python)
- **推論エンジン**: PyMC
- **可視化**: Arviz (PyMCと統合された可視化ライブラリ)
- **データ処理**: Pandas
- **タスクキュー**: Celery + Redis (長時間実行タスクの非同期処理)

### 9.3 サーバー構成
| サーバー役割 | 技術 | 説明 |
|-------------|------|------|
| Webサーバー | Nginx | 静的ファイル配信、リバースプロキシ |
| APIサーバー | FastAPI | REST API提供 |
| ワーカーサーバー | Celery | サンプリング・推論の非同期実行 |
| メッセージブローカー | Redis | タスクキュー管理、セッション管理 |

### 9.4 データストレージ
- **セッション管理**: Redis
- **結果の一時保存**: ファイルシステム or MinIO (オブジェクトストレージ)
- **分布定義**: JSON/YAMLファイル

### 9.5 デプロイメント
- **コンテナ化**: Docker + Docker Compose
- **本番環境**: Kubernetes (スケーラビリティが必要な場合)

---

---

## 10. 開発フェーズ提案

### Phase 1: 基本機能 (MVP)
- [ ] グラフィカルモデルの構築UI（ノード・エッジの追加・編集）
- [ ] 基本分布の実装（Normal, Bernoulli, Poisson）
- [ ] PyMCコード生成機���
- [ ] CSVデータ読み込み
- [ ] NUTSサンプリング実行
- [ ] 基本的な結果表示（トレースプロット、パラメータ推定値）

### Phase 2: 拡張機能
- [ ] プレート記法のサポート
- [ ] 多変量分布の対応
- [ ] VI (Variational Inference) サポート
- [ ] 詳細な収束診断表示
- [ ] 事前分布・事後予測機能

### Phase 3: 高度な機能
- [ ] 分布の動的追加機能
- [ ] モデルのエクスポート・インポート
- [ ] モデルテンプレート機能（よく使うモデルの保存）
- [ ] パフォーマンス最適化

---

---

## 11. 要件確定事項まとめ

### 11.1 演算ノード
- ✅ ドロップダウンメニューで演算タイプを選択
- ✅ 対応演算: 和、差、積、行列積、exp、log、sqrt、abs、sigmoid、softmax
- ✅ ブロードキャスティングは自動判定
- ✅ ノード上に演算式を表示（例: `X @ beta`）
- ✅ 演算定義はJSONで外部ファイル化し、コード変更なしで追加可能

### 11.2 データ対応付け
- ✅ CSVの列とモデル変数は手動で対応付け
- ✅ ドロップダウンで列を選択
- ✅ 多次元変数は列ごとまたは列範囲で指定

### 11.3 形状指定
- ✅ `(N, K)` 記法で入力
- ✅ `n_observations` はデータ行数の予約語
- ✅ 多次元も同様: `(n_observations, K, D)`

### 11.4 その他
- ✅ ユーザー管理機能は不要（セッションベース）
- ✅ 処理中はローディングマークを表示

---

## 12. 次のステップ

### 完了した設計項目
- [x] 演算ノードの仕様確定
- [x] データとモデルの対応付け方法
- [x] 形状指定の仕様
- [x] UI/UX基本設計

### 次に詳細化が必要な項目
1. **エラーハンドリングの詳細設計**
   - モデル整合性チェックのエラーメッセージ
   - サンプリング失敗時の対処フロー

2. **結果のエクスポート機能**
   - エクスポート形式（JSON、CSV、HTMLレポート等）
   - モデル定義のインポート/エクスポート

3. **システムアーキテクチャの詳細設計**
   - API設計
   - データフロー設計
   - セッション管理の詳細

4. **分布・演算定義のJSONスキーマ設計**

5. **プロトタイプ開発開始（Phase 1 MVP）**
